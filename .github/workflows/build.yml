name: Build AutoRGB Application

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  SOLUTION_FILE_PATH: AutoRGBPrototype.sln
  BUILD_CONFIGURATION: Release

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        platform: [x64, x86, arm64]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.3

    - name: Setup NuGet
      uses: nuget/setup-nuget@v1
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages
      run: nuget restore ${{ env.SOLUTION_FILE_PATH }}

    - name: Clean build directories
      shell: pwsh
      run: |
        Write-Host "Cleaning build directories..."
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype/Release" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype/Debug" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype/x64" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype/x86" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype/arm64" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype (Package)/x64" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype (Package)/x86" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "AutoRGBPrototype/AutoRGBPrototype (Package)/arm64" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "Release" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "Debug" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "x64" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "x86" -ErrorAction SilentlyContinue
        Remove-Item -Recurse -Force "arm64" -ErrorAction SilentlyContinue
        Get-ChildItem -Recurse -Filter "*.tlog" -ErrorAction SilentlyContinue | Remove-Item -Force -ErrorAction SilentlyContinue
        Write-Host "Build directories cleaned."

    - name: Clean solution
      run: msbuild ${{ env.SOLUTION_FILE_PATH }} /t:Clean /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ matrix.platform }}

    - name: Build solution
      run: msbuild ${{ env.SOLUTION_FILE_PATH }} /p:Configuration=${{ env.BUILD_CONFIGURATION }} /p:Platform=${{ matrix.platform }} /p:AppxBundle=Never /p:UapAppxPackageBuildMode=SideloadOnly

    # --- NEW: Decode PFX from secrets ---
    - name: Prepare signing certificate
      shell: pwsh
      run: |
        $pfxBase64 = "${{ secrets.WINDOWS_PFX_BASE64 }}"
        if ([string]::IsNullOrEmpty($pfxBase64)) {
          Write-Host "Certificate secrets not configured. Signing will be skipped."
          exit 0
        }
        
        $pfxPath = Join-Path $env:RUNNER_TEMP "codesign.pfx"
        [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($pfxBase64))
        "PFX_PATH=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        Write-Host "Certificate prepared for signing."

    # --- NEW: Sign all MSIX files ---
    - name: Sign MSIX packages
      shell: pwsh
      run: |
        # Check if certificate was prepared
        if ([string]::IsNullOrEmpty($env:PFX_PATH) -or !(Test-Path $env:PFX_PATH)) {
          Write-Host "Certificate not available. Skipping signing."
          exit 0
        }
        
        $pfxPassword = "${{ secrets.WINDOWS_PFX_PASSWORD }}"
        if ([string]::IsNullOrEmpty($pfxPassword)) {
          Write-Host "Certificate password not configured. Skipping signing."
          exit 0
        }

        $signtool = Join-Path ${env:ProgramFiles(x86)} "Windows Kits\10\bin\x64\signtool.exe"
        if (!(Test-Path $signtool)) { throw "signtool.exe not found at $signtool" }

        $targets = @()
        if (Test-Path "AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages") {
          $targets += Get-ChildItem "AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages" -Recurse -Filter *.msix -ErrorAction SilentlyContinue
        }
        if (Test-Path "AutoRGBPrototype/AutoRGBPrototype (Package)/${{ matrix.platform }}") {
          $targets += Get-ChildItem "AutoRGBPrototype/AutoRGBPrototype (Package)/${{ matrix.platform }}" -Recurse -Filter *.msix -ErrorAction SilentlyContinue
        }

        if ($targets.Count -eq 0) {
          Write-Host "No .msix files found to sign."
          exit 0
        }

        foreach ($f in $targets) {
          Write-Host "Signing $($f.FullName)"
          & $signtool sign /fd SHA256 /f "$env:PFX_PATH" /p $pfxPassword /tr http://timestamp.digicert.com /td SHA256 "$($f.FullName)"
          if ($LASTEXITCODE -ne 0) { throw "signtool failed for $($f.FullName)" }
        }
        
        Write-Host "All MSIX packages signed successfully."

    - name: List build output
      shell: pwsh
      run: |
        Write-Host "Listing build output directories..."
        if (Test-Path "AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages") {
          Get-ChildItem -Path "AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages" -Recurse | Select-Object FullName
        }
        if (Test-Path "AutoRGBPrototype/AutoRGBPrototype (Package)/${{ matrix.platform }}") {
          Get-ChildItem -Path "AutoRGBPrototype/AutoRGBPrototype (Package)/${{ matrix.platform }}" -Recurse | Select-Object FullName
        }

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AutoRGBPrototype-${{ matrix.platform }}-${{ env.BUILD_CONFIGURATION }}
        path: |
          AutoRGBPrototype/AutoRGBPrototype (Package)/AppPackages/**/*
          AutoRGBPrototype/AutoRGBPrototype (Package)/${{ matrix.platform }}/${{ env.BUILD_CONFIGURATION }}/**/*
        if-no-files-found: warn
